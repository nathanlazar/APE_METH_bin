# Steps of analysis looking at methylation around breakpoints in non-human apes (and rhesus)
# nathan dot lazar at gmail dot com

# The steps run on the gibbon reads from NLE Vok are given in the
# ALL_STEPS_VOK file in /home/lazar/VOK_BS_GENOME on moloch

dir=/mnt/lustre1/users/lazar/APE_METH/POST_CRASH/
read_dir=$dir/RAW_READS/
big_bin_dir=/mnt/lustre1/users/lazar/bin/
my_bin_dir=$dir/APE_METH_bin/

# Versions:
# java version "1.7.0_65"
# fastqc_v0.11.2
# trim_galore_v0.3.7
# cutadapt-1.7.1
# bsmooth-align-0.8.1
# seqtk: 1.0-r77-dirty

# 1) Map bisulfite reads to gibbon, human, chimp, gorilla, orangutan and rhesus genomes.

# 1.1) Raw files from gibbon sequencing runs were coppied from moloch:
#      /home/lazar/VOK_BS_GENOME/READS/
#      Raw reads for other species were coppied from hoolock:
#      /u1/tomas_BS/raw_data except for
#      Julia_FCC02FUACXX_L6_1.fq.gz and Julia_FCC02FUACXX_L6_2.fq.gz
#      Which were corrupted. Correct versions were obtained from:
#      /u0/dbase/nl/APE_METH/ on hoolock ***I'm not sure about this***

# I renamed these by hand so they all end in _1.fq.gz and _2.fq.gz and moved them into 
# directories inside of RAW_READs named Gibbbon, Human, Orangutan, Gorilla, Chimp, Rhesus

# 1.2) Run FastQC on all the raw reads in parallel with HTCondor
./$my_bin_dir/fastqc_condor.sh RAW_READS/Gibbon FASTQC_RAW/Gibbon
./$my_bin_dir/fastqc_condor.sh RAW_READS/Human FASTQC_RAW/Human
./$my_bin_dir/fastqc_condor.sh RAW_READS/Orangutan FASTQC_RAW/Orangutan
./$my_bin_dir/fastqc_condor.sh RAW_READS/Gorilla FASTQC_RAW/Gorilla
./$my_bin_dir/fastqc_condor.sh RAW_READS/Chimp FASTQC_RAW/Chimp
./$my_bin_dir/fastqc_condor.sh RAW_READS/Rhesus FASTQC_RAW/Rhesus

# 1.3) Trim adapters:
#      - removes base calls with a Phred score of 20 or lower (assuming Sanger encoding)
#      - removes any signs of the Illumina adapter sequence from the 3' end (AGATCGGAAGAGC)
#      - removes sequences that got shorter than 20 bp
#      - runs fastqc on the resulting reads
#      - stores results in ADAPT_TRIM
./$my_bin_dir/trim_adapt_condor.sh RAW_READS ADAPT_TRIM

# 1.4) Run FastQC on the trimmed reads
./$my_bin_dir/fastqc_condor.sh ADAPT_TRIM FASTQC_TRIM

# 1.5) Map first 250,000 reads and generate mbias plots to 
#      judge trimming
mkdir TEST_MAP
./$my_bin_dir/align_top250000_all.sh
# This outputs files <read_name>_val_1/mbias.tsv
# Rename these:
for f in $(ls TEST_MAP/*_val_1/mbias.tsv)
  do new=$(echo $f | sed 's:val_1/mbias.tsv:test_mbias.tsv:')
  mv $f $new
done

# 1.5) Generate plots to determine trimming
Rscript ./$my_bin_dir/test_map_mbias_plots.R

# 1.6) Trim reads uniformly based on mbias plots and quality scores
mkdir TRIMMED
./$my_bin_dir/trim_uniform.sh ADAPT_TRIM TRIMMED 5 5

# Gzip results
for f in $(ls TRIMMED/*.fq); do gzip $f; done

# 1.7) Map trimmed reads.
mkdir MAPPED
./$my_bin_dir/align_all.sh

#** HERE **#


# 1.6) Combine reads for each species

# Chimp
cat TRIMMED/4369_FCC02G0ACXX_L2_1_val_1.fq TRIMMED/4369_FCC02G0ACXX_L3_1_val_1.fq \
  > TRIMMED/Chimp_1.fq
cat TRIMMED/4369_FCC02G0ACXX_L2_2_val_2.fq TRIMMED/4369_FCC02G0ACXX_L3_2_val_2.fq \
  > TRIMMED/Chimp_2.fq

# Orangutan
cat TRIMMED/Dunja_FCC0CGEACXX_L4_1_val_1.fq TRIMMED/Dunja_FCC0CGUACXX_L4_1_val_1.fq \
  TRIMMED/Dunja_FCD0JPEACXX_L1_1_val_1.fq > TRIMMED/Orang_1.fq
cat TRIMMED/Dunja_FCC0CGEACXX_L4_2_val_2.fq TRIMMED/Dunja_FCC0CGUACXX_L4_2_val_2.fq \
  TRIMMED/Dunja_FCD0JPEACXX_L1_2_val_2.fq  > TRIMMED/Orang_2.fq

# Gorilla
cat TRIMMED/Gorilla_FCC02G0ACXX_L7_1_val_1.fq TRIMMED/Gorilla_FCC02G0ACXX_L8_1_val_1.fq \
  TRIMMED/Gorilla_FCD0GB2ACXX_L6_1_val_1.fq > TRIMMED/Gorilla_1.fq
cat TRIMMED/Gorilla_FCC02G0ACXX_L7_2_val_2.fq TRIMMED/Gorilla_FCC02G0ACXX_L8_2_val_2.fq \
  TRIMMED/Gorilla_FCD0GB2ACXX_L6_2_val_2.fq > TRIMMED/Gorilla_2.fq

# Human
cat TRIMMED/Julia_FCC02FUACXX_L6_1_val_1.fq TRIMMED/Julia_FCC02FUACXX_L8_1_val_1.fq \
  > TRIMMED/Human_1.fq
cat TRIMMED/Julia_FCC02FUACXX_L6_2_val_2.fq TRIMMED/Julia_FCC02FUACXX_L8_2_val_2.fq \
  > TRIMMED/Human_2.fq

# Rhesus
mv TRIMMED/Rhesus_DNA130327BF_25184-0_R1_val_1.fq TRIMMED/Rhesus_1.fq
mv TRIMMED/Rhesus_DNA130327BF_25184-0_R2_val_2.fq TRIMMED/Rhesus_2.fq

# Delete individual files
rm TRIMMED/4369_FC*
rm TRIMMED/Dunja_FC*
rm TRIMMED/Gorilla_FC*
rm TRIMMED/Julia_FC*

# Compress
gzip TRIMMED/*

# 1.7) Align in parallel using Bsmooth

# Human
   ./gibbon_meth/batch_align.sh \
     human_hg19_noIUPAC/human_hg19_noIUPAC.fa \
     TRIMMED/Human_1.fq.gz \
     TRIMMED/Human_2.fq.gz \
     HUMAN_MAPPED \
     500000 \
     50 &> Human_align.out

# Gorilla
   ./gibbon_meth/batch_align.sh \
     gorilla_gorGor3/gorilla_gorGor3.fa \
     TRIMMED/Gorilla_1.fq.gz \
     TRIMMED/Gorilla_2.fq.gz \
     GORILLA_MAPPED \
     500000 \
     50 &> Gorilla_align.out

# Chimp
   ./gibbon_meth/batch_align.sh \
     chimp_panTro4/chimp_panTro4.fa \
     TRIMMED/Chimp_1.fq.gz \
     TRIMMED/Chimp_2.fq.gz \
     CHIMP_MAPPED \
     500000 \
     50 &> Chimp_align.out

# Orangutan
   ./gibbon_meth/batch_align.sh \
     orangutan_ponAbe2/orangutan_ponAbe2.fa \
     TRIMMED/Orang_1.fq.gz \
     TRIMMED/Orang_2.fq.gz \
     MAPPED \
     ORANG_500000 \
     50 &> Orang_align.out

# Rhesus
   ./gibbon_meth/batch_align.sh \
     rhesus_v7/rhesus_v7.fa \
     TRIMMED/Rhesus_1.fq.gz \
     TRIMMED/Rhesus_2.fq.gz \
     RHESUS_MAPPED \
     500000 \
     50 &> Rhesus_align.out


